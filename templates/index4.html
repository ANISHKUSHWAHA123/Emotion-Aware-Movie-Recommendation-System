<!DOCTYPE html>
<html>
  <head>
    <title>Emotion-Based Movie Recommendation System</title>
    <style>
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      .movie-card {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .movie-poster {
        margin-right: 20px;
      }

      .movie-poster img {
        max-width: 200px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .movie-details {
        max-width: 60%;
      }
    </style>
  </head>
  <body>
    <h1>Welcome to Emotion-Based Movie Recommendation System</h1>
    <button onclick="capture()">Get Recommendations</button>
    <div id="output"></div>

    <!-- Modal for new user input -->
    <div id="newUserModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>New User Detected!</h2>
        <form id="newUserForm">
          <label for="userName">Enter Your Name:</label>
          <input type="text" id="userName" name="userName" required />
          <button type="submit">Submit</button>
        </form>
      </div>
    </div>

    <script>
      const TMDB_API_KEY = "86e015e9ab57897be2dcac577f18400a";
      const TMDB_BASE_URL = "https://api.themoviedb.org/3";

      async function fetchMovieDetails(movieName) {
        const searchUrl = `${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(
          movieName
        )}`;
        const searchResponse = await fetch(searchUrl);
        const searchData = await searchResponse.json();

        if (!searchData.results || searchData.results.length === 0) {
          return { error: "Movie not found" };
        }

        const movieId = searchData.results[0].id;
        const detailsUrl = `${TMDB_BASE_URL}/movie/${movieId}?api_key=${TMDB_API_KEY}`;
        const videosUrl = `${TMDB_BASE_URL}/movie/${movieId}/videos?api_key=${TMDB_API_KEY}`;

        const [detailsResponse, videosResponse] = await Promise.all([
          fetch(detailsUrl),
          fetch(videosUrl),
        ]);

        const detailsData = await detailsResponse.json();
        const videosData = await videosResponse.json();

        const posterPath = detailsData.poster_path
          ? `https://image.tmdb.org/t/p/w500${detailsData.poster_path}`
          : null;
        const trailer = videosData.results.find(
          (video) => video.type === "Trailer"
        );
        const trailerUrl = trailer
          ? `https://www.youtube.com/watch?v=${trailer.key}`
          : null;

        return {
          name: detailsData.title,
          genres: detailsData.genres.map((genre) => genre.name),
          posterUrl: posterPath,
          trailerUrl: trailerUrl,
        };
      }

      async function capture() {
        const response = await fetch("/process", { method: "POST" });
        const data = await response.json();

        if (data.error) {
          document.getElementById("output").innerHTML = "Error: " + data.error;
        } else if (data.status === "new_user") {
          document.getElementById("newUserModal").style.display = "block";
        } else {
          const movieDetails = await Promise.all(
            data.recommendations.map((movie) => fetchMovieDetails(movie.title))
          );

          const movieCards = movieDetails
            .map((movie) =>
              movie.error
                ? `<p>Error fetching details for ${movie.name}</p>`
                : `
              <div class="movie-card">
                <div class="movie-poster">
                  ${
                    movie.posterUrl
                      ? `<img src="${movie.posterUrl}" alt="${movie.name} Poster" />`
                      : "No Poster Available"
                  }
                </div>
                <div class="movie-details">
                  <h3>${movie.name}</h3>
                  <p>Genres: ${movie.genres.join(", ")}</p>
                  ${
                    movie.trailerUrl
                      ? `<a href="${movie.trailerUrl}" target="_blank">Watch Trailer</a>`
                      : "No Trailer Available"
                  }
                </div>
              </div>`
            )
            .join("");

          document.getElementById("output").innerHTML = `
            <h3>Emotion Detected: ${data.emotion}</h3>
            <h3>User: ${data.user}</h3>
            ${movieCards}
          `;
        }
      }

      function closeModal() {
        document.getElementById("newUserModal").style.display = "none";
      }
    </script>
  </body>
</html>
